<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Digital Edition Viewer</title>
  <style>
    :root{
      --bg: #0b111a;
      --panel: #101826;
      --ink: #eef3ff;
      --muted: #a9b6d3;
      --accent: #7cc6ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --toolbar-h: 54px;
      --thumb-w: 108px;
    }
    html, body { height: 100%; background: var(--bg); color: var(--ink); margin: 0; }
    body { display: grid; grid-template-rows: var(--toolbar-h) 1fr; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }

    /* Toolbar */
    .toolbar{ display:flex; align-items:center; gap:10px; padding:8px 12px; height:var(--toolbar-h); background:linear-gradient(180deg,#0e1623,#0b111a); border-bottom:1px solid #1b2740; position:sticky; top:0; z-index:10; }
    .group{ display:flex; align-items:center; gap:6px; background: var(--panel); border:1px solid #1f2b45; padding:4px; border-radius: 12px; box-shadow: var(--shadow); }
    .btn{ -webkit-tap-highlight-color: transparent; appearance:none; cursor:pointer; display:inline-grid; place-items:center; width:36px; height:36px; border:0; border-radius:10px; background:#0f1a2b; color:var(--ink); transition:transform .06s ease, background .12s; }
    .btn:hover{ background:#13233a; }
    .btn:active{ transform:translateY(1px); }
    .btn[disabled]{ opacity:.45; pointer-events:none; }
    .label{ color:var(--muted); font-size:13px; letter-spacing:.2px; }
    .field{ height:36px; min-width:60px; padding:0 10px; border-radius:10px; border:1px solid #1f2b45; background:#0f1a2b; color:var(--ink); text-align:center; }
    .grow{ flex:1; }

    /* Layout */
    .wrap{ display:grid; grid-template-columns: 0 1fr; /* thumbs width toggled via JS */ height: 100%; min-height: 0; }
    .thumbs{ background: #0d1626; border-right:1px solid #1b2740; overflow:auto; overscroll-behavior: contain; padding:10px; gap:10px; display:grid; grid-auto-rows:min-content; }
    .thumb{ width:var(--thumb-w); background:#0f1a2b; border:1px solid #1e2740; border-radius: 10px; padding:6px; cursor:pointer; box-shadow: var(--shadow); }
    .thumb.active{ outline:2px solid var(--accent); }
    .thumb canvas{ width:100%; height:auto; display:block; border-radius:6px; }

    .stage{ position:relative; overflow:auto; overscroll-behavior: contain; background: radial-gradient(1000px 400px at 50% -200px, #0f1828, #0b111a); }
    .pageLayer{ display:grid; place-items:center; padding: 22px; min-height:100%; }
    .spread{ display:grid; grid-auto-flow:column; gap: 18px; align-items:start; justify-content:center; }
    .page{ background:#0f1a2b; border:1px solid #1d2742; border-radius:12px; padding:10px; box-shadow: var(--shadow); position:relative; }
    .page canvas{ display:block; border-radius:8px; width:100%; height:auto; }

    /* Floating helpers */
    .helper{ position:fixed; right:14px; bottom:14px; display:grid; gap:10px; z-index:11; }

    .k{ font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#9fb3d9; }

    /* Mobile */
    @media (max-width: 900px){
      :root{ --toolbar-h: 50px; --thumb-w: 88px; }
      .wrap{ grid-template-columns: 0 1fr; }
      .pageLayer{ padding: 12px; }
      .group.hide-mobile{ display:none; }
    }
  </style>
</head>
<body>
  <!-- Toolbar -->
  <div class="toolbar" role="region" aria-label="Document controls">
    <div class="group">
      <button class="btn" id="openThumbs" title="Toggle thumbnails" aria-pressed="false">üìö</button>
      <button class="btn" id="single" title="Single page">üóé</button>
      <button class="btn" id="double" title="Two-page spread">üóè</button>
    </div>

    <div class="group">
      <button class="btn" id="prev" title="Previous page" aria-keyshortcuts="ArrowLeft">‚óÄ</button>
      <input class="field" id="pageInput" type="number" min="1" value="1" aria-label="Page" />
      <span class="label" id="pageCount">/ 0</span>
      <button class="btn" id="next" title="Next page" aria-keyshortcuts="ArrowRight">‚ñ∂</button>
    </div>

    <div class="group">
      <button class="btn" id="zoomOut" title="Zoom out">‚àí</button>
      <span class="label" id="zoomLabel">100%</span>
      <button class="btn" id="zoomIn" title="Zoom in">Ôºã</button>
      <button class="btn" id="fitWidth" title="Fit to width">‚ÜîÔ∏é</button>
    </div>

    <div class="group hide-mobile">
      <input class="field" id="findInput" placeholder="Find text‚Ä¶" style="min-width:200px;text-align:left" />
      <button class="btn" id="findNext" title="Find next">üîé</button>
    </div>

    <div class="grow"></div>

    <div class="group">
      <a class="btn" id="download" title="Download" href="#" download>‚§ì</a>
    </div>
  </div>

  <!-- Workspace -->
  <div class="wrap">
    <aside class="thumbs" id="thumbs" aria-label="Page thumbnails"></aside>
    <main class="stage" id="stage" role="main">
      <div class="pageLayer">
        <div class="spread" id="spread"></div>
      </div>
    </main>
  </div>

  <!-- Floating helper tips -->
  <div class="helper" aria-hidden="true">
    <div class="group" style="padding:8px 10px;">
      <div class="k">Tip: Swipe left/right ‚Ä¢ Pinch to zoom ‚Ä¢ Arrow keys navigate</div>
    </div>
  </div>

  <!-- PDF.js (via CDN) -->
  <script>
    // Choose a stable build. If you self-host, update these two URLs accordingly.
    const PDFJS_VIEWER = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174";
  </script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    /* =====================================================
       Digital Edition Viewer (lightweight PDF.js wrapper)
       Features: thumbnails, single/two-page, fit-to-width,
       swipe & pinch, search (simple), keyboard nav
       ===================================================== */

    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    // --- Config & state ---
    const params = new URLSearchParams(location.search);
    const DEFAULT_SRC = "https://api.nem-aus.atexcloud.io/file-service/file/content/ZDQ2MDc5MTYtMTE4ZC00/c3036606-5dc8-4e8c-8de1-83627b14f10f";
    const SRC = params.get("src") || DEFAULT_SRC; // pass ?src=ENCODED_URL when embedding

    const state = {
      pdf: null,
      pageCount: 0,
      current: 1,
      scale: 1,
      baseScale: 1, // recalculated on resize/fit
      twoPage: false,
      thumbsOpen: false,
      rendering: new Map(),
    };

    // PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = `${PDFJS_VIEWER}/build/pdf.worker.min.js`;

    // Elements
    const stage = $('#stage');
    const spread = $('#spread');
    const thumbs = $('#thumbs');

    const prevBtn = $('#prev');
    const nextBtn = $('#next');
    const pageInput = $('#pageInput');
    const pageCountEl = $('#pageCount');
    const zoomLabel = $('#zoomLabel');
    const zoomInBtn = $('#zoomIn');
    const zoomOutBtn = $('#zoomOut');
    const fitWidthBtn = $('#fitWidth');
    const singleBtn = $('#single');
    const doubleBtn = $('#double');
    const openThumbsBtn = $('#openThumbs');
    const downloadLink = $('#download');
    const findInput = $('#findInput');
    const findNextBtn = $('#findNext');

    downloadLink.href = SRC;

    // --- Helpers ---
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
    function setZoomLabel(){ zoomLabel.textContent = Math.round(state.scale * 100) + '%'; }
    function setPageUI(){ pageInput.value = state.current; pageCountEl.textContent = ` / ${state.pageCount}`; prevBtn.disabled = state.current <= 1; nextBtn.disabled = state.current >= state.pageCount; }

    function toggleThumbs(force){
      state.thumbsOpen = force ?? !state.thumbsOpen;
      const col = state.thumbsOpen ? 240 : 0;
      document.querySelector('.wrap').style.gridTemplateColumns = `${col}px 1fr`;
      openThumbsBtn.setAttribute('aria-pressed', String(state.thumbsOpen));
    }

    function setTwoPage(on){ state.twoPage = !!on; singleBtn.disabled = !on; doubleBtn.disabled = on; renderSpread(); }

    function fitToWidth(){
      // Estimate scale so current page width fits viewport (minus padding)
      const pageEl = spread.querySelector('.page');
      if(!pageEl) return;
      const canvas = pageEl.querySelector('canvas');
      const stageW = stage.clientWidth - (state.twoPage ? 40 : 0) - 32; // gaps & padding
      const scale = clamp(stageW / canvas.width, .3, 3.5);
      state.baseScale = scale; state.scale = scale; setZoomLabel(); renderSpread();
    }

    function zoom(delta){ state.scale = clamp(state.scale * (delta>0 ? 1.1 : 1/1.1), .3, 4); setZoomLabel(); renderSpread(/*reuseViewport=*/true); }

    // --- Rendering ---
    async function renderPage(num, container){
      if(num < 1 || num > state.pageCount) return;
      const key = `${num}@${state.scale.toFixed(3)}`;
      if(state.rendering.get(key)) return state.rendering.get(key);

      const page = await state.pdf.getPage(num);
      const viewport = page.getViewport({ scale: state.scale * (window.devicePixelRatio || 1) });

      let canvas = container.querySelector('canvas');
      if(!canvas){ canvas = document.createElement('canvas'); container.innerHTML = ''; container.appendChild(canvas); }
      const ctx = canvas.getContext('2d', { alpha: false });
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);
      canvas.style.width = Math.floor(viewport.width / (window.devicePixelRatio || 1)) + 'px';
      canvas.style.height = Math.floor(viewport.height / (window.devicePixelRatio || 1)) + 'px';

      const task = page.render({ canvasContext: ctx, viewport });
      state.rendering.set(key, task.promise);
      await task.promise; // ensure draw completes
      state.rendering.delete(key);
    }

    function pageBox(){ const el = document.createElement('div'); el.className = 'page'; el.setAttribute('role','region'); return el; }

    async function renderSpread(reuseViewport=false){
      spread.innerHTML = '';
      const leftNum = state.current;
      const rightNum = state.twoPage ? clamp(leftNum+1, 1, state.pageCount) : null;

      const left = pageBox(); left.setAttribute('aria-label', `Page ${leftNum}`); spread.appendChild(left);
      if(state.twoPage && rightNum && rightNum !== leftNum){ const right = pageBox(); right.setAttribute('aria-label', `Page ${rightNum}`); spread.appendChild(right); await Promise.all([renderPage(leftNum,left), renderPage(rightNum,right)]); }
      else { await renderPage(leftNum, left); }

      // Update active thumb highlight
      $$('.thumb').forEach(t => t.classList.toggle('active', Number(t.dataset.n) === state.current));
    }

    async function renderThumb(n){
      const t = document.createElement('div'); t.className = 'thumb'; t.dataset.n = n; t.title = `Page ${n}`;
      const canvas = document.createElement('canvas'); t.appendChild(canvas);
      thumbs.appendChild(t);
      const page = await state.pdf.getPage(n);
      const viewport = page.getViewport({ scale: 0.2 });
      const ctx = canvas.getContext('2d');
      canvas.width = viewport.width; canvas.height = viewport.height;
      await page.render({ canvasContext: ctx, viewport }).promise;
      t.addEventListener('click', () => { state.current = n; setPageUI(); renderSpread(); });
    }

    async function loadPDF(src){
      const loadingTask = pdfjsLib.getDocument({ url: src, withCredentials: false });
      state.pdf = await loadingTask.promise;
      state.pageCount = state.pdf.numPages;
      state.current = 1;
      setPageUI();

      // Build thumbs lazily to keep first paint quick
      thumbs.innerHTML = '';
      const first = Math.min(12, state.pageCount);
      for(let i=1; i<=first; i++) renderThumb(i);
      // Queue the rest after first interaction/idle
      requestIdleCallback?.(async () => { for(let i=first+1; i<=state.pageCount; i++) await renderThumb(i); })

      // Initial render
      state.scale = 1; setZoomLabel();
      await renderSpread();
      fitToWidth(); // then fit after first paint so we can measure canvas width
    }

    // --- Events ---
    window.addEventListener('resize', () => fitToWidth());

    prevBtn.addEventListener('click', () => { state.current = clamp(state.current-1,1,state.pageCount); setPageUI(); renderSpread(); });
    nextBtn.addEventListener('click', () => { state.current = clamp(state.current+1,1,state.pageCount); setPageUI(); renderSpread(); });
    pageInput.addEventListener('change', () => { const n = clamp(parseInt(pageInput.value||'1',10),1,state.pageCount); state.current=n; setPageUI(); renderSpread(); });

    zoomInBtn.addEventListener('click', () => zoom(+1));
    zoomOutBtn.addEventListener('click', () => zoom(-1));
    fitWidthBtn.addEventListener('click', fitToWidth);

    singleBtn.addEventListener('click', () => setTwoPage(false));
    doubleBtn.addEventListener('click', () => setTwoPage(true));
    openThumbsBtn.addEventListener('click', () => toggleThumbs());

    // Keyboard
    window.addEventListener('keydown', (e) => {
      if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
      if (e.key === 'ArrowLeft') prevBtn.click();
      else if (e.key === 'ArrowRight') nextBtn.click();
      else if (e.key === '+') zoomInBtn.click();
      else if (e.key === '-') zoomOutBtn.click();
      else if (e.key === 'w') fitWidthBtn.click();
      else if (e.key === 't') openThumbsBtn.click();
    });

    // Touch gestures (simple)
    let touchStartX = 0, touchStartDist = 0, pinching = false;
    stage.addEventListener('touchstart', (e) => {
      if(e.touches.length === 1){ touchStartX = e.touches[0].clientX; pinching = false; }
      if(e.touches.length === 2){ pinching = true; touchStartDist = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      ); }
    }, {passive:true});
    stage.addEventListener('touchmove', (e) => {
      if(pinching && e.touches.length === 2){
        const d = Math.hypot(
          e.touches[0].clientX - e.touches[1].clientX,
          e.touches[0].clientY - e.touches[1].clientY
        );
        if(Math.abs(d - touchStartDist) > 10){ zoom(d > touchStartDist ? +1 : -1); touchStartDist = d; }
      }
    }, {passive:true});
    stage.addEventListener('touchend', (e) => {
      if(!pinching && e.changedTouches.length){
        const dx = e.changedTouches[0].clientX - touchStartX;
        if(Math.abs(dx) > 60){ dx < 0 ? nextBtn.click() : prevBtn.click(); }
      }
    });

    // Simple find (incremental): highlights are non-trivial on canvas; we jump to next match page
    findNextBtn.addEventListener('click', async () => {
      const q = (findInput.value||'').trim(); if(!q) return;
      for(let i=state.current; i<=state.pageCount; i++){
        const text = await (await (await state.pdf.getPage(i)).getTextContent()).items.map(x=>x.str).join(' ');
        if(text.toLowerCase().includes(q.toLowerCase())){ state.current = i; setPageUI(); await renderSpread(); break; }
      }
    });
    findInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') findNextBtn.click(); });

    // Kick it off
    toggleThumbs(false);
    setTwoPage(false);
    loadPDF(SRC).catch(err => {
      console.error(err);
      spread.innerHTML = `<div style="opacity:.8;max-width:720px;text-align:center">\n        <h2>We couldn't load this PDF</h2>\n        <p>Please check that the file URL is accessible and has CORS enabled.<br/>\n           As a fallback, you can <a href="${SRC}" target="_blank" rel="noopener">open it directly</a>.\n        </p>\n      </div>`;
    });
  </script>
</body>
</html>
